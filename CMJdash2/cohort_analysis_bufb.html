<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cohort Analysis - BUFB 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-base-100">
    <div class="container mx-auto p-4 max-w-7xl">
        
        <!-- Header -->
        <div class="bg-base-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold" id="cohort-title">Position Cohort Analysis</h1>
                    <p class="text-base-content/70 mt-1" id="cohort-subtitle">Select a position to view detailed cohort analysis</p>
                </div>
                <div class="flex gap-2">
                    <select id="position-selector" class="select select-bordered select-sm">
                        <option value="">Select Position</option>
                        <option value="WR">WR - Wide Receiver</option>
                        <option value="S">S - Safety</option>
                        <option value="CB">CB - Cornerback</option>
                        <option value="RB">RB - Running Back</option>
                        <option value="TE">TE - Tight End</option>
                        <option value="QB">QB - Quarterback</option>
                        <option value="LB">LB - Linebacker</option>
                        <option value="OLB">OLB - Outside Linebacker</option>
                        <option value="DL">DL - Defensive Line</option>
                        <option value="OL">OL - Offensive Line</option>
                        <option value="K">K - Kicker</option>
                        <option value="P">P - Punter</option>
                        <option value="LS">LS - Long Snapper</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="exportCohort()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Cohort Statistics -->
        <div id="cohort-stats" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                <div class="bg-base-200 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-1">Athletes in Position</div>
                    <div class="text-3xl font-bold" id="stat-athletes">0</div>
                </div>

                <div class="bg-base-200 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-1">Total Tests</div>
                    <div class="text-3xl font-bold" id="stat-tests">0</div>
                </div>

                <div class="bg-base-200 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-1">Avg Jump Height</div>
                    <div class="text-3xl font-bold"><span id="stat-jump">0</span> <span class="text-lg">cm</span></div>
                </div>

                <div class="bg-base-200 rounded-lg p-4">
                    <div class="text-sm text-base-content/70 mb-1">Avg Peak Power</div>
                    <div class="text-3xl font-bold"><span id="stat-power">0</span> <span class="text-lg">W</span></div>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="bg-base-200 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-bold mb-3">Jump Height Distribution</h3>
                <canvas id="distribution-chart"></canvas>
            </div>

            <!-- Cohort Table -->
            <div class="bg-base-200 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold">Athlete Performance Table</h2>
                    <select id="sort-selector" class="select select-bordered select-sm">
                        <option value="name">Sort by: Name</option>
                        <option value="jump">Sort by: Jump Height</option>
                        <option value="power">Sort by: Peak Power</option>
                        <option value="rsi">Sort by: RSI-modified</option>
                        <option value="tests">Sort by: Test Count</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="table table-sm table-zebra">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Athlete</th>
                                <th>Number</th>
                                <th>Tests</th>
                                <th>Latest Jump (cm)</th>
                                <th>Latest Power (W)</th>
                                <th>Latest Force (N)</th>
                                <th>Latest RSI</th>
                                <th>Body Weight (kg)</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="cohort-table-body">
                            <tr><td colspan="10" class="text-center">Select a position to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="bg-base-200 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-bold mb-3">Position Top Performers</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="bg-base-300 rounded-lg p-3">
                        <h4 class="font-bold mb-2 text-sm text-primary">Highest Jump</h4>
                        <div id="top-jump" class="text-sm">--</div>
                    </div>
                    <div class="bg-base-300 rounded-lg p-3">
                        <h4 class="font-bold mb-2 text-sm text-success">Highest Power</h4>
                        <div id="top-power" class="text-sm">--</div>
                    </div>
                    <div class="bg-base-300 rounded-lg p-3">
                        <h4 class="font-bold mb-2 text-sm text-info">Highest RSI</h4>
                        <div id="top-rsi" class="text-sm">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center">
            <button class="btn btn-ghost" onclick="window.close()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Return to Dashboard
            </button>
        </div>

    </div>

    <script>
        let cmjData = [];
        let currentPosition = '';
        let distributionChart = null;

        Chart.defaults.color = '#a6adbb';
        Chart.defaults.borderColor = 'rgba(166, 173, 187, 0.1)';

        // Load data
        fetch('processed_cmj_data.json')
            .then(response => response.json())
            .then(data => {
                cmjData = data;
                console.log('Loaded', cmjData.length, 'CMJ tests');
            })
            .catch(error => console.error('Error loading CMJ data:', error));

        // Position selector
        document.getElementById('position-selector').addEventListener('change', function() {
            const position = this.value;
            if (!position) {
                document.getElementById('cohort-stats').classList.add('hidden');
                return;
            }
            
            currentPosition = position;
            displayCohortAnalysis(position);
        });

        // Sort selector
        document.getElementById('sort-selector').addEventListener('change', function() {
            if (currentPosition) {
                displayCohortAnalysis(currentPosition);
            }
        });

        function displayCohortAnalysis(position) {
            // Filter data for position
            const positionData = cmjData.filter(entry => entry.position === position);
            
            // Get athlete summaries (latest test for each athlete)
            const athletes = {};
            positionData.forEach(entry => {
                if (!athletes[entry.name] || new Date(entry.date) > new Date(athletes[entry.name].date)) {
                    athletes[entry.name] = entry;
                }
            });

            // Count tests per athlete
            const testCounts = {};
            positionData.forEach(entry => {
                testCounts[entry.name] = (testCounts[entry.name] || 0) + 1;
            });

            // Calculate statistics
            const athleteList = Object.values(athletes);
            const avgJump = athleteList.reduce((sum, a) => sum + a.jump_height_cm, 0) / athleteList.length;
            const avgPower = athleteList.reduce((sum, a) => sum + a.peak_power, 0) / athleteList.length;

            // Update header
            document.getElementById('cohort-title').textContent = `${position} Position Cohort Analysis`;
            document.getElementById('cohort-subtitle').textContent = `${athleteList.length} Athletes â€¢ ${positionData.length} Total Tests`;

            // Update stats
            document.getElementById('stat-athletes').textContent = athleteList.length;
            document.getElementById('stat-tests').textContent = positionData.length;
            document.getElementById('stat-jump').textContent = avgJump.toFixed(1);
            document.getElementById('stat-power').textContent = Math.round(avgPower);

            // Sort athletes
            const sortBy = document.getElementById('sort-selector').value;
            athleteList.sort((a, b) => {
                switch(sortBy) {
                    case 'jump': return b.jump_height_cm - a.jump_height_cm;
                    case 'power': return b.peak_power - a.peak_power;
                    case 'rsi': return b.rsi_modified - a.rsi_modified;
                    case 'tests': return testCounts[b.name] - testCounts[a.name];
                    default: return a.name.localeCompare(b.name);
                }
            });

            // Update table
            const tbody = document.getElementById('cohort-table-body');
            tbody.innerHTML = '';
            athleteList.forEach((athlete, index) => {
                const performance = getPerformanceRating(athlete.jump_height_cm, avgJump);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-bold">${index + 1}</td>
                    <td class="font-semibold">${athlete.name}</td>
                    <td>#${athlete.number}</td>
                    <td>${testCounts[athlete.name]}</td>
                    <td class="font-semibold">${athlete.jump_height_cm.toFixed(1)}</td>
                    <td class="font-semibold">${Math.round(athlete.peak_power)}</td>
                    <td>${Math.round(athlete.peak_force)}</td>
                    <td>${athlete.rsi_modified.toFixed(2)}</td>
                    <td>${athlete.bw_kg.toFixed(1)}</td>
                    <td><span class="badge ${performance.class} badge-sm">${performance.label}</span></td>
                `;
                tbody.appendChild(row);
            });

            // Update top performers
            const topJump = [...athleteList].sort((a, b) => b.jump_height_cm - a.jump_height_cm)[0];
            const topPower = [...athleteList].sort((a, b) => b.peak_power - a.peak_power)[0];
            const topRSI = [...athleteList].sort((a, b) => b.rsi_modified - a.rsi_modified)[0];

            document.getElementById('top-jump').innerHTML = `<strong>${topJump.name}</strong><br>${topJump.jump_height_cm.toFixed(1)} cm`;
            document.getElementById('top-power').innerHTML = `<strong>${topPower.name}</strong><br>${Math.round(topPower.peak_power)} W`;
            document.getElementById('top-rsi').innerHTML = `<strong>${topRSI.name}</strong><br>${topRSI.rsi_modified.toFixed(2)}`;

            // Update distribution chart
            updateDistributionChart(athleteList);

            // Show section
            document.getElementById('cohort-stats').classList.remove('hidden');
        }

        function getPerformanceRating(value, avg) {
            const percentDiff = ((value - avg) / avg) * 100;
            if (percentDiff > 15) return { label: 'Excellent', class: 'badge-success' };
            if (percentDiff > 5) return { label: 'Good', class: 'badge-info' };
            if (percentDiff > -5) return { label: 'Average', class: 'badge-ghost' };
            if (percentDiff > -15) return { label: 'Monitor', class: 'badge-warning' };
            return { label: 'Needs Work', class: 'badge-error' };
        }

        function updateDistributionChart(athletes) {
            const jumpHeights = athletes.map(a => a.jump_height_cm).sort((a, b) => a - b);
            
            // Create bins
            const min = Math.floor(Math.min(...jumpHeights) / 5) * 5;
            const max = Math.ceil(Math.max(...jumpHeights) / 5) * 5;
            const binSize = 5;
            const bins = {};
            
            for (let i = min; i <= max; i += binSize) {
                bins[`${i}-${i + binSize}`] = 0;
            }
            
            jumpHeights.forEach(height => {
                const binStart = Math.floor(height / binSize) * binSize;
                const binLabel = `${binStart}-${binStart + binSize}`;
                if (bins[binLabel] !== undefined) {
                    bins[binLabel]++;
                }
            });

            const ctx = document.getElementById('distribution-chart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(bins),
                    datasets: [{
                        label: 'Number of Athletes',
                        data: Object.values(bins),
                        backgroundColor: 'rgba(96, 165, 250, 0.6)',
                        borderColor: 'rgb(96, 165, 250)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Athletes'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Jump Height Range (cm)'
                            }
                        }
                    }
                }
            });
        }

        function exportCohort() {
            alert('Export functionality would generate a CSV or PDF with the current cohort data.');
        }
    </script>
</body>
</html>